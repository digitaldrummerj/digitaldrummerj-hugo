<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta property="og:title" content="Strongloop - Fixing Security When Extending User Model" />
  <meta property="og:description" content="After following Raymond Camden&rsquo;s Strongloop Introduction, I was ready to update the todo demo application that I have been using for the Ionic Arizona Meetup. So I created a models for projects and app users. The app users model base class was User. Then within the project model I associated a project to an app users with a belongsTo and in the app users model I associated multiple projects to a single user with a hasMany."
  />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://digitaldrummerj.me/strongloop-extending-user-model-security/" />
  <meta property="article:published_time" content="2015-10-30T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2015-10-30T00:00:00&#43;00:00" />
  <meta itemprop="name" content="Strongloop - Fixing Security When Extending User Model">
  <meta itemprop="description" content="After following Raymond Camden&rsquo;s Strongloop Introduction, I was ready to update the todo demo application that I have been using for the Ionic Arizona Meetup. So I created a models for projects and app users. The app users model base class was User. Then within the project model I associated a project to an app users with a belongsTo and in the app users model I associated multiple projects to a single user with a hasMany.">
  <meta itemprop="datePublished" content="2015-10-30T00:00:00&#43;00:00" />
  <meta itemprop="dateModified" content="2015-10-30T00:00:00&#43;00:00" />
  <meta itemprop="wordCount" content="740">
  <meta itemprop="keywords" content="" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Strongloop - Fixing Security When Extending User Model" />
  <meta name="twitter:description" content="After following Raymond Camden&rsquo;s Strongloop Introduction, I was ready to update the todo demo application that I have been using for the Ionic Arizona Meetup. So I created a models for projects and app users. The app users model base class was User. Then within the project model I associated a project to an app users with a belongsTo and in the app users model I associated multiple projects to a single user with a hasMany."
  />
  <meta name="msvalidate.01" content="E414777C8C1E619FC57F320448FD584A" />
  <base href="http://digitaldrummerj.me/">
  <link rel="canonical" href="http://digitaldrummerj.me/strongloop-extending-user-model-security/">
  <title>Justin James</title>
  <link href="http://digitaldrummerj.me/css/app.css" rel="stylesheet">
  <script src="http://digitaldrummerj.me/js/modernizr.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Lato:400,700,400italic:latin', 'Volkhov::latin']
      }
    });
  </script> <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'>
  </noscript>
  <link href="http://digitaldrummerj.me//feed.xml" rel="alternate" type="application/rss+xml" title="Justin James" />
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Lato:400,700,400italic:latin', 'Volkhov::latin']
      }
    });
  </script> <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'>
</noscript> </head>

<body id="top-of-page">
  <div id="navigation" class="sticky">
    <nav class="top-bar" role="navigation" data-topbar>
      <ul class="title-area">
        <li class="name">
          <h1 class="show-for-small-only"><a href="http://digitaldrummerj.me/" class="icon-tree"> Justin James</a></h1>
        </li>
        <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li>
      </ul>
      <section class="top-bar-section">
        <ul class="left">
          <li><a href="http://digitaldrummerj.me/">
                Home
              </a></li>
          <li><a href="http://digitaldrummerj.me/speaking/">Speaking Engagements</a></li>
          <li><a href="http://digitaldrummerj.me/blog/">Blog</a></li>
          <li class="has-dropdown  not-click"> <a href="/workshops/">Workshops </a>
            <ul class="dropdown">
              <li class="parent-link hide-for-large-up"> <a class="parent-link js-generated" href="/workshops/">Workshops </a> </li>
              <li> <a href="http://digitaldrummerj.me/sails-tutorial">Rapid API Development with SailsJS</a></li>
              <li> <a href="http://digitaldrummerj.me/angular-tutorial">Up and Running with Angular</a></li>
            </ul>
          </li>
        </ul>
        <ul class="right">
          <li><a href="http://digitaldrummerj.me/about/">About</a></li>
          <li><a href="http://digitaldrummerj.me/contact/">Contact</a></li>
          <li><a href="http://digitaldrummerj.me/search/">Search</a></li>
        </ul>
      </section>
    </nav>
  </div>
  <div id="masthead-no-image-header">
    <div class="row">
      <div class="small-12 columns"> <a id="logo" href="http://digitaldrummerj.me/" title="Justin James">
                <img src="/images/logo.png" alt="Justin James">
              </a> </div>
    </div>
  </div>
  <div class="row t30">
    <div class="small-12 columns medium-8">
      <header>
        <div itemprop="name">
          <h1>Strongloop - Fixing Security When Extending User Model</h1>
        </div>
        <div id="page-meta" class="t10"> <span class="pr20"><span class="icon-calendar"></span> <time datetime="2015-10-30T00:00:00Z">
        Fri Oct 30, 2015
      </time> </span> <span class="meta-tags">
  <span class="icon-price-tag"></span> <span> 
<a href="/categories/ionic">ionic</a>/ <a href="/categories/strongloop">strongloop</a>
</span></span>
        </div>
        <p>
          <div class="series-nav">
            <p>This article is part of a series. </p>
            <ul class="side-nav">
              <li class="current"><span>Part 1 - This Article</span> </ul>
          </div>
        </p>
        <p>
          <p>After following Raymond Camden&rsquo;s <a href="http://www.raymondcamden.com/tags/strongloop/">Strongloop Introduction</a>, I was ready to update the <a href="https://github.com/Ionic-AZ/Todo-Lab1-LocalStorage">todo demo application</a> that
            I have been using for the <a href="http://meetup.com/ionic-az">Ionic Arizona Meetup</a>. So I created a models for projects and app users. The app users model base class was User. Then within the project model I associated a project to an
            app users with a belongsTo and in the app users model I associated multiple projects to a single user with a hasMany. At this point, when I examined the API explorer I could see that it can me a rest endpoint to get the projects associated
            to a user. However, I ran into an issue with getting 401 Unauthorized errors when I tried to query any of the rest endpoints to get the projects associated to the user.</p>
          <p>I could not find anything in the Strongloop docs that told me how to get around the 401 errors or what was causing them except that the ACL security was causing the issue and that I should be able to set the ACL security for appuser. However,
            after much research, it turns out that the built-in user model has security (ACL) on it to restrict everyone from being able to query the user endpoints that do not have an explictly defined security setup. This is great except for the fact
            that even if you add additional ACLs in your extended user model the default security has already denied the user before it gets to the security you setup.</p>
          <p>You can view the default security by navigating to your strongloop project directory and looking in the node_modules\loopback\common\models\user.json file. You can see looking at the ACL list that the first item in the list is to DENY $everyone</p>
          <pre><code>    {
        &quot;principalType&quot;: &quot;ROLE&quot;,
        &quot;principalId&quot;: &quot;$everyone&quot;,
        &quot;permission&quot;: &quot;DENY&quot;
    }
</code></pre>
          <p>The way Strongloop orders the ACLs is that it starts at the bottom of the ACL list and reads it to the top. Since we are extending the user class, the DENY $everyone will come before our defined ACL. Strongloop strongly suggest that you do not
            modify the built-in user class, so then how do we allow users to query our additional endpoints?</p>
          <p>When you generate a model there is an accompanying file for each model in the common\models directory, that has a .js extension to write custom code to add additional functionality to the model. For example if your model is called appuser, you
            will see two files: appuser.json and appuser.js.</p>
          <p>Go ahead and open up the .js extension for your model. You will the following code where Appuser is your model&rsquo;s name.</p>
          <pre><code>module.exports = function(Appuser) {
};
</code></pre>
          <p>The first thing to do is clear out the existing security for the model</p>
          <p>Appuser.settings.acls.length = 0;</p>
          <p>Next we need to create a file in the models directory to hold the ACL for the model. My file naming convention is to add &ldquo;acl&rdquo; after the model name like so [Your Model]acl.json, ex: appuseracl.json</p>
          <p>To ensure that you do not lose any of the default security, copy the ACLs json from the node_modules\loopback\common\model\user.json file</p>
          <pre><code>&quot;acls&quot;: [
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principal&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;DENY&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;create&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$owner&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;deleteById&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;login&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;logout&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$owner&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;findById&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$owner&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;updateAttributes&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;confirm&quot;
  },
  {
    &quot;principalType&quot;: &quot;ROLE&quot;,
    &quot;principalId&quot;: &quot;$everyone&quot;,
    &quot;permission&quot;: &quot;ALLOW&quot;,
    &quot;property&quot;: &quot;resetPassword&quot;,
    &quot;accessType&quot;: &quot;EXECUTE&quot;
  }
]
</code></pre>
          <p>Now that the ACL configuration is setup, you need to tell Strongloop to load it by add the following line to the [Your Model].js file</p>
          <pre><code>Appuser.settings.acls = require('./appuseracl.json');
</code></pre>
          <p>If you test your rest endpoints, at this point you will have the security as your started with.</p>
          <p>To add the security for your added endpoints, add them before the DENY everyone configuration that is at the top of the ACL list.</p>
          <pre><code>    {
        &quot;principalType&quot;: &quot;ROLE&quot;,
        &quot;principalId&quot;: &quot;$everyone&quot;,
        &quot;permission&quot;: &quot;DENY&quot;
    }
</code></pre>
          <p>For example here is the ACL for my app users model to get the list of projects associated to that user.</p>
          <pre><code>    {
        &quot;principalType&quot;: &quot;ROLE&quot;,
        &quot;principalId&quot;: &quot;$owner&quot;,
        &quot;permission&quot;: &quot;ALLOW&quot;,
        &quot;property&quot;: &quot;__get__projects&quot;
    }
</code></pre>
          <p>If you test your rest endpoints again, you will be able to successfully call the endpoints that were added when you associated projects to a user in your user model.</p>
        </p>
        <p>
          <div class="series-nav">
            <p>This article is part of a series. </p>
            <ul class="side-nav">
              <li class="current"><span>Part 1 - This Article</span> </ul>
          </div>
        </p>
        <p>
          <h4>Share Post:</h4>
          <section id="sharer" class="small-12 columns social-icons">
            <ul class="inline-list">
              <li> <a class="share-twitter icon-twitter" target="_blank" href="https://twitter.com/intent/tweet?text=Strongloop%20-%20Fixing%20Security%20When%20Extending%20User%20Model&via=digitaldrummerj" title="Tweet this"></a> </li>
              <li> <a class="share-facebook icon-facebook" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fdigitaldrummerj.me%2fstrongloop-extending-user-model-security%2f" title="Share on Facebook"></a> </li>
              <li> <a class="share-email icon-mail " target="_blank" href="mailto:subject=Strongloop%20-%20Fixing%20Security%20When%20Extending%20User%20Model&http://digitaldrummerj.me/strongloop-extending-user-model-security/" title="Send ia email"></a> </li>
              <li> <a class=" share-googleplus icon-googleplus" target="_blank" href="https://plus.google.com/share?url=http%3a%2f%2fdigitaldrummerj.me%2fstrongloop-extending-user-model-security%2f" title="Share on Google+"></a> </li>
              <li> <a class="share-linkedin icon-linkedin" target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fdigitaldrummerj.me%2fstrongloop-extending-user-model-security%2f" title="Share on LinkedIn"></a> </li>
            </ul>
          </section>
        </p>
    </div>
    <div class="hide-for-small-only medium-4 columns" data-sticky-container>
      <aside class="sidebar">
        <div class="panel radius">
          <h3>Subscribe</h3>
          <ul class="no-bullet">
            <li><span class="icon-rss"></span><a href="http://digitaldrummerj.me//feed.xml">RSS Feed</a>
              <li><span class="icon-rss"></span><a href="http://digitaldrummerj.me//atom.xml">Atom Feed</a></ul>
        </div>
        <div class="panel radius latePost">
          <h3>Recent Posts <span style="float: right"><small>(<a href="http://digitaldrummerj.me//blog/">All Posts</a>)</small></span></h3>
          <ul class="no-bullet ">
            <li><a href="/node-download-zip-and-extract/">Download and Extract Zip File with Node</a></li>
            <li><a href="/ng2-karma-not-finding-tests/">Angular 2 - No  Test Found</a></li>
            <li><a href="/ng2-add-bootstrap/">Angular 2 - Adding Bootstrap Library</a></li>
            <li><a href="/ng2-your-first-project/">Angular 2 - Your First Project</a></li>
            <li><a href="/ng2-wtf-my-module-wont-route/">Angular - WTF Module Won&rsquo;t Route</a></li>
          </ul>
        </div>
        <div class="panel radius">
          <h3>Archive</h3>
          <ul class="no-bullet">
            <li><span class="icon-archive"></span><a href="http://digitaldrummerj.me//blog/archive/monthview">By Date</a></li>
            <li><span class="icon-archive"></span><a href="http://digitaldrummerj.me//blog/archive/categoryview">By Category</a></li>
            <li><span class="icon-archive"></span><a href="http://digitaldrummerj.me//blog/archive/tagcloudview">By Tag Cloud</a></li>
          </ul>
        </div>
        <div class="panel radius">
          <h3>Categories</h3>
          <ul class="no-bullet">
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/android">Android &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/angular">Angular &nbsp;<span>(8)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/bash">Bash &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/blogging">Blogging &nbsp;<span>(19)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/book-reviews">Book Reviews &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/bower">Bower &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/c">C# &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/camtasia">Camtasia &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/chocolatey">Chocolatey &nbsp;<span>(5)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/chrome">Chrome &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/community">Community &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/cors">Cors &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/debugging">Debugging &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/docker">Docker &nbsp;<span>(3)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/git">Git &nbsp;<span>(5)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/github">Github &nbsp;<span>(5)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/gulp">Gulp &nbsp;<span>(4)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/how-to">How To &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/iis">Iis &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/ionic">Ionic &nbsp;<span>(16)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/jekyll">Jekyll &nbsp;<span>(18)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/markdown">Markdown &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/meetup">Meetup &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/node">Node &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/nodejs">Nodejs &nbsp;<span>(3)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/npm">Npm &nbsp;<span>(4)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/nuget">Nuget &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/powershell">Powershell &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/productivity">Productivity &nbsp;<span>(5)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/programming">Programming &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/proxy">Proxy &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/speaking">Speaking &nbsp;<span>(4)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/strongloop">Strongloop &nbsp;<span>(1)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/vagrant">Vagrant &nbsp;<span>(9)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/virtualbox">Virtualbox &nbsp;<span>(6)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/visual-studio">Visual Studio &nbsp;<span>(6)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/web-api">Web Api &nbsp;<span>(3)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/webapi">Webapi &nbsp;<span>(2)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/windows">Windows &nbsp;<span>(4)</span></a></li>
            <li><span class="icon-price-tag"></span><a href="http://digitaldrummerj.me/categories/year-in-review">Year in Review &nbsp;<span>(1)</span></a></li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
  </div>
  <footer id="footer-content" class="bg-grau">
    <div id="footer">
      <div class="row">
        <div class="medium-6 columns">
          <h5 class="shadow-black">About This Site</h5>
          <p class="shadow-black"> Sharing my knowledge with others in a manner that is easy to understand and consume. <a href="/about/">More ›</a></p>
        </div>
        <div class="small-12 medium-6 columns">
          <h5 class="shadow-black">Services</h5>
          <ul class="no-bullet shadow-black">
            <li> <a href="" title=""></a></li>
            <li class="icon-mail"> <a href="/contact/" title="Contact">Contact</a></li>
            <li class="icon-rss"> <a href="/feed.xml" type="application/rss+xml" title="Subscribe to RSS Feed">RSS</a></li>
            <li class="icon-rss"><a href="/atom.xml" type="application/rss+xml" title="Subscribe to Atom Feed">Atom</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="subfooter">
      <nav class="row">
        <section id="subfooter-left" class="small-12 medium-6 columns credits">
          <p>Created with ♥ by <a href="/about/">Justin James</a>. All content is the property of Justin James and digitaldrummerj.me. This blog, its content, and opinions are my own.</p>
        </section>
        <section id="subfooter-right" class="small-12 medium-6 columns social-icons">
          <ul class="inline-list">
            <li><a href="https://github.com/digitaldrummerj" target="_blank" class="icon-github" title="Code and such..."></a></li>
            <li><a href="https://www.youtube.com/channel/UCDMvOL1XSKclxwplUT0fzLA" target="_blank" class="icon-youtube" title="Tech Videos"></a></li>
            <li><a href="https://twitter.com/digitaldrummerj" target="_blank" class="icon-twitter" title="Twitter"></a></li>
          </ul>
        </section>
      </nav>
    </div>
  </footer>
  <foot>
    <script src="http://digitaldrummerj.me/js/jquery-3.1.1.min.js"></script>
    <script src="http://digitaldrummerj.me/js/javascript.min.js"></script>
    <script src="http://digitaldrummerj.me/js/app.js"></script>
  </foot>
</body>

</html>